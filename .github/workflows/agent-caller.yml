name: Kinen Agent

on:
  repository_dispatch:
    types: [email_session_start, email_session_continue]
  
  # Also trigger on issue comments (for GitHub UI replies)
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  session:
    # Only run if:
    # - repository_dispatch (email), OR
    # - issue_comment on kinen-session issue, not from a bot
    if: |
      github.event_name == 'repository_dispatch' ||
      (
        github.event_name == 'issue_comment' &&
        contains(github.event.issue.labels.*.name, 'kinen-session') &&
        github.event.comment.user.type != 'Bot'
      )
    uses: kinen-club/workflows/.github/workflows/agent.yml@main
    with:
      # Google OAuth Client ID (for free Gemini access)
      # This is Kinen Club's public OAuth app - not a secret
      google_client_id: "116369305764-c9ke327pk2ttdml2m78cns0fmrupfu7m.apps.googleusercontent.com"
    secrets:
      # Google OAuth (FREE - 1000 requests/day, set automatically by Kinen)
      GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
      # OpenRouter (access to all models)
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      # Or use direct provider keys:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
